{% extends "dashboardbase.html" %}

{% block content %}
<link href="/static/style.css" rel="stylesheet">

<script type="text/javascript" src="/realtimewebui/externals/knockout-3.1.0.js"></script>
<script type='text/javascript' src='/static/common.js'></script>
<script type='text/javascript' src='/static/css.js'></script>

<div class="container">
    <h2>Inauguration Time by Host (in seconds)</h3>
    <table class="table" id="inaugurationsByHost">
        <thead>
            <tr data-bind="foreach: byHost.headers">
                <th><a href="#" data-bind="click: $parent.sort, text: title"></a></th>
            </tr>
            <tr data-bind="visible: byHost.isActivateCompactModeButtonVisible">
                <td colspan="3">
                    <span data-bind="text: byHost.values().length"></span> Total |
                    <a href="#" data-bind="click: byHost.toggleVisibility">Hide records</a> |
                    (Click a column name to sort by)
                </td>
            </tr>
            <tr data-bind="visible: byHost.isDeactivateCompactModeButtonVisible">
                <td colspan="3">
                    <span data-bind="text: byHost.values().length"></span> Total |
                    <a href="#" data-bind="click: byHost.toggleVisibility">Show all records</a> |
                    (Click a column name to sort by)
                </td>
            </tr>
        </thead>
        <tbody data-bind="foreach: byHost.values">
            <tr>
                <td data-bind="text: $index() + 1"></td>
                <td data-bind="text: _id"></td>
                <td data-bind="text: averageInaugurationTime"></td>
            </tr>
        </tbody>
        <tfoot>
            <tr data-bind="visible: byHost.isActivateCompactModeButtonVisible">
                <td colspan="3">
                    <a href="#" data-bind="click: byHost.toggleVisibility">Hide records</a>
                </td>
            </tr>
            <tr data-bind="visible: byHost.isDeactivateCompactModeButtonVisible">
                <td colspan="3">
                    <a href="#" data-bind="click: byHost.toggleVisibility">. . . Show all records</a>
                </td>
            </tr>
        </tfoot>
    </table>
    <h2>Inauguration Time by Label (in seconds)</h3>
    <table class="table" id="inaugurationsByLabel">
        <thead>
            <tr data-bind="foreach: byLabel.headers">
                <th><a href="#" data-bind="click: $parent.sort, text: title"></a></th>
            </tr>
            <tr data-bind="visible: byLabel.isActivateCompactModeButtonVisible">
                <td colspan="3">
                    <span data-bind="text: byLabel.values().length"></span> Total |
                    <a href="#" data-bind="click: byLabel.toggleVisibility">Hide records</a> |
                    (Click a column name to sort by)
                </td>
            </tr>
            <tr data-bind="visible: byLabel.isDeactivateCompactModeButtonVisible">
                <td colspan="3">
                    <span data-bind="text: byLabel.values().length"></span> Total |
                    <a href="#" data-bind="click: byLabel.toggleVisibility">. . . Show all records</a> |
                    (Click a column name to sort by)
                </td>
            </tr>
        </thead>
        <tbody data-bind="foreach: byLabel.values">
            <tr>
                <td data-bind="text: $index() + 1"></td>
                <td data-bind="text: _id"></td>
                <td data-bind="text: averageInaugurationTime"></td>
            </tr>
        </tbody>
        <tfoot>
            <tr data-bind="visible: byLabel.isActivateCompactModeButtonVisible">
                <td colspan="3">
                    <a href="#" data-bind="click: byLabel.toggleVisibility">Hide records</a>
                </td>
            </tr>
            <tr data-bind="visible: byLabel.isDeactivateCompactModeButtonVisible">
                <td colspan="3">
                    <a href="#" data-bind="click: byLabel.toggleVisibility">Show all records</a>
                </td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
NR_RECORDS_IN_COMPACT_MODE = 5

function httpGet(theUrl)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", theUrl, false);
    xmlHttp.send(null);
    response = JSON.parse(xmlHttp.responseText);
    return response
}

function fixNumberFormat(statsObject)
{
    statsObject.forEach(function(unused, index, arr) {
        arr[index].averageInaugurationTime = Number(arr[index].averageInaugurationTime.toFixed(1));
    });
}

function InaugurationTimesTableViewModel(tableId, url, columnName) {
    var self = this;
    self.tableId = tableId
    self.values = ko.observableArray([]);
    self.isCompact = ko.observable(false);
    self.isActivateCompactModeButtonVisible = ko.observable(false);
    self.isDeactivateCompactModeButtonVisible = ko.observable(false);
    self.headers = [
        {title: ''},
        {title: columnName, sortPropertyName: '_id', asc: true},
        {title: 'Average Time', sortPropertyName: 'averageInaugurationTime', asc: true}
    ];
    self.activeSort = self.headers[0];
    self.sort = function(header, event) {
        alert("sorting...");
        toggleBack = false;
        if (self.isCompact()) {
            toggleBack = true;
            self.toggleVisibility()
        }
        //if this header was just clicked a second time
        if(self.activeSort === header) {
            header.asc = !header.asc;
        } else {
            self.activeSort = header;
        }
        var prop = self.activeSort.sortPropertyName;
        var ascSort = function(a,b){ return a[prop] < b[prop] ? -1 : a[prop] > b[prop] ? 1 : a[prop] == b[prop] ? 0 : 0; };
        var descSort = function(a,b){ return a[prop] > b[prop] ? -1 : a[prop] < b[prop] ? 1 : a[prop] == b[prop] ? 0 : 0; };
        var sortFunc = self.activeSort.asc ? ascSort : descSort;
        self.values.sort(sortFunc);
        if (toggleBack) {
            self.toggleVisibility();
        }
    };
    self.toggleVisibility = function() {
        firstHiddenRowNumberInCompactMode = NR_RECORDS_IN_COMPACT_MODE + 1
        hiddenRowsInCompactModeQuery = 'tr:gt(' + firstHiddenRowNumberInCompactMode + ')';
        hiddenRowsInCompactMode = $('#' + self.tableId).find(hiddenRowsInCompactModeQuery);
        if (self.isCompact()) {
            hiddenRowsInCompactMode.show();
            self.isCompact(false);
            self.isActivateCompactModeButtonVisible(true);
            self.isDeactivateCompactModeButtonVisible(false);
        } else {
            hiddenRowsInCompactMode.hide();
            self.isCompact(true);
            self.isActivateCompactModeButtonVisible(false);
            self.isDeactivateCompactModeButtonVisible(true);
        }
    }
    self.setStats = function() {
        statsObject = httpGet(url)
        if (!statsObject)
            return;
        fixNumberFormat(statsObject)
        self.values(statsObject);
        if (self.values().length > NR_RECORDS_IN_COMPACT_MODE) {
            self.toggleVisibility()
        }
    }
}

function InaugurationTimesPageViewModel() {
    var self = this;
    var generalUrl = "http://localhost:6001/averageInaugurationTime";
    self.byHost = new InaugurationTimesTableViewModel("inaugurationsByHost",
                                                      generalUrl + "?by=host",
                                                      "Host")
    self.byLabel = new InaugurationTimesTableViewModel("inaugurationsByLabel",
                                                       generalUrl + "?by=label",
                                                       "Label")
    self.setStats = function() {
        self.byHost.setStats()
        self.byLabel.setStats()
    }
}

var viewModel = new InaugurationTimesPageViewModel();
ko.applyBindings(viewModel);
viewModel.setStats()

</script>

{% endblock %}
